<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Laberinto Din√°mico con Enemigos</title>
    <style>
        body {
            background: #0f172a;
            display: flex;
            justify-content: center;
            align-items: center;
            flex-direction: column;
            min-height: 100vh;
            font-family: sans-serif;
            color: white;
        }

        #laberinto {
            display: grid;
            grid-template-columns: repeat(21, 30px);
            grid-template-rows: repeat(21, 30px);
            gap: 2px;
            margin-top: 20px;
        }

        .celda {
            width: 30px;
            height: 30px;
            background: #0f172a;
        }

        .pared {
            background: #1a2647;
        }

        .jugador {
            background: #00a2ff;
            border-radius: 5px;
            box-shadow: 0 0 10px #00a2ff;
        }

        .meta {
            background: #28a745;
            border-radius: 5px;
            box-shadow: 0 0 10px #28a745;
        }

        .enemigo {
            background: #ff3030;
            border-radius: 50%;
            box-shadow: 0 0 10px #ff0000;
        }
    </style>
</head>

<body>
    <h2>üèÉ ¬°Escapa del laberinto!</h2>
    <p>Usa las flechas. Los monstruos te perseguir√°n si te ven.</p>
    <div id="laberinto"></div>

    <script>
        const filas = 21;
        const columnas = 21;
        const laberinto = document.getElementById('laberinto');
        let mapa = [];
        let jugador = { x: 1, y: 1 };
        let enemigos = [];

        // Crear laberinto con DFS
        function generarLaberinto() {
            mapa = Array.from({ length: filas }, () => Array(columnas).fill(1));

            function tallar(x, y) {
                const dirs = [
                    [2, 0],
                    [-2, 0],
                    [0, 2],
                    [0, -2]
                ].sort(() => Math.random() - 0.5);

                for (const [dx, dy] of dirs) {
                    const nx = x + dx, ny = y + dy;
                    if (nx > 0 && ny > 0 && nx < columnas - 1 && ny < filas - 1 && mapa[ny][nx] === 1) {
                        mapa[ny - dy / 2][nx - dx / 2] = 0;
                        mapa[ny][nx] = 0;
                        tallar(nx, ny);
                    }
                }
            }

            mapa[1][1] = 0;
            tallar(1, 1);
            mapa[filas - 2][columnas - 2] = 2;
        }

        function dibujarLaberinto() {
            laberinto.innerHTML = '';
            for (let y = 0; y < filas; y++) {
                for (let x = 0; x < columnas; x++) {
                    const celda = document.createElement('div');
                    celda.classList.add('celda');
                    if (mapa[y][x] === 1) celda.classList.add('pared');
                    if (mapa[y][x] === 2) celda.classList.add('meta');
                    if (x === jugador.x && y === jugador.y) celda.classList.add('jugador');
                    for (const e of enemigos) {
                        if (e.x === x && e.y === y) celda.classList.add('enemigo');
                    }
                    laberinto.appendChild(celda);
                }
            }
        }

        function moverJugador(dx, dy) {
            const nx = jugador.x + dx;
            const ny = jugador.y + dy;
            if (nx < 0 || ny < 0 || nx >= columnas || ny >= filas) return;
            if (mapa[ny][nx] === 1) return;
            jugador.x = nx;
            jugador.y = ny;

            if (mapa[ny][nx] === 2) {
                alert('üéâ ¬°Has ganado!');
                reiniciar();
            }

            verificarColision();
            dibujarLaberinto();
        }

        // ‚úÖ BFS r√°pido (solo un paso hacia el jugador)
        function pasoHaciaJugador(inicio, objetivo) {
            const cola = [inicio];
            const cameFrom = {};
            const hash = p => `${p.x},${p.y}`;
            cameFrom[hash(inicio)] = null;

            while (cola.length > 0) {
                const actual = cola.shift();
                if (actual.x === objetivo.x && actual.y === objetivo.y) break;

                const dirs = [
                    { x: actual.x + 1, y: actual.y },
                    { x: actual.x - 1, y: actual.y },
                    { x: actual.x, y: actual.y + 1 },
                    { x: actual.x, y: actual.y - 1 }
                ];

                for (const v of dirs) {
                    if (v.x < 0 || v.y < 0 || v.x >= columnas || v.y >= filas) continue;
                    if (mapa[v.y][v.x] === 1) continue;
                    if (cameFrom[hash(v)]) continue;
                    cameFrom[hash(v)] = actual;
                    cola.push(v);
                }
            }

            // reconstruir solo el primer paso
            let paso = objetivo;
            let previo = cameFrom[hash(paso)];
            if (!previo) return null;
            while (previo && cameFrom[hash(previo)]) {
                paso = previo;
                previo = cameFrom[hash(previo)];
            }
            return paso;
        }

        // ‚úÖ Movimiento enemigos mejorado
        function moverEnemigos() {
            for (const e of enemigos) {
                let moved = false;

                if (lineaVision(e, jugador)) {
                    // Si ve al jugador ‚Üí lo persigue un paso
                    const paso = pasoHaciaJugador(e, jugador);
                    if (paso) {
                        e.x = paso.x;
                        e.y = paso.y;
                        moved = true;
                    }
                }

                // Si no lo ve ‚Üí patrulla aleatoria larga
                if (!moved) {
                    const caminos = [];
                    const dirs = [
                        [1, 0], [-1, 0], [0, 1], [0, -1]
                    ];

                    // buscar direcciones v√°lidas
                    for (const [dx, dy] of dirs) {
                        const nx = e.x + dx, ny = e.y + dy;
                        if (nx > 0 && ny > 0 && nx < columnas - 1 && ny < filas - 1 && mapa[ny][nx] === 0) {
                            caminos.push({ x: nx, y: ny });
                        }
                    }

                    if (caminos.length > 0) {
                        const move = caminos[Math.floor(Math.random() * caminos.length)];
                        e.x = move.x;
                        e.y = move.y;
                    }
                }
            }

            verificarColision();
            dibujarLaberinto();
        }

        // ‚úÖ L√≠nea de visi√≥n con l√≠mite de distancia
        function lineaVision(enemigo, jugador) {
            const dist = Math.abs(enemigo.x - jugador.x) + Math.abs(enemigo.y - jugador.y);
            if (dist > 7) return false;
            if (enemigo.x === jugador.x) {
                const [minY, maxY] = [Math.min(enemigo.y, jugador.y), Math.max(enemigo.y, jugador.y)];
                for (let y = minY + 1; y < maxY; y++) if (mapa[y][enemigo.x] === 1) return false;
                return true;
            }
            if (enemigo.y === jugador.y) {
                const [minX, maxX] = [Math.min(enemigo.x, jugador.x), Math.max(enemigo.x, jugador.x)];
                for (let x = minX + 1; x < maxX; x++) if (mapa[enemigo.y][x] === 1) return false;
                return true;
            }
            return false;
        }

        function verificarColision() {
            for (const e of enemigos) {
                if (e.x === jugador.x && e.y === jugador.y) {
                    alert('üíÄ ¬°Te atraparon!');
                    reiniciar();
                }
            }
        }

        function reiniciar() {
            generarLaberinto();
            jugador = { x: 1, y: 1 };
            generarEnemigos(4);
            dibujarLaberinto();
        }

        function generarEnemigos(num) {
            enemigos = [];
            for (let i = 0; i < num; i++) {
                let x, y;
                do {
                    x = Math.floor(Math.random() * columnas);
                    y = Math.floor(Math.random() * filas);
                } while (mapa[y][x] !== 0 || (x === 1 && y === 1) || (x === columnas - 2 && y === filas - 2));
                enemigos.push({ x, y });
            }
        }

        // Controles
        document.addEventListener('keydown', e => {
            if (e.key === 'ArrowUp') moverJugador(0, -1);
            if (e.key === 'ArrowDown') moverJugador(0, 1);
            if (e.key === 'ArrowLeft') moverJugador(-1, 0);
            if (e.key === 'ArrowRight') moverJugador(1, 0);
        });

        // Inicializaci√≥n
        generarLaberinto();
        generarEnemigos(4);
        dibujarLaberinto();
        setInterval(moverEnemigos, 600);
    </script>
</body>

</html>